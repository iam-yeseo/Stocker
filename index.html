<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Stocker - Ï£ºÏãù ÏãúÎÆ¨Î†àÏù¥ÏÖò</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            color: #1a1a1a;
            overflow-x: hidden;
            padding-bottom: 80px;
            user-select: none;
            -webkit-user-select: none;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
            padding-top: 70px;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            padding: 12px 15px;
            z-index: 100;
            border-bottom: 1px solid #e5e5e5;
            box-shadow: none;
        }

        .header-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: 800;
            color: #1a1a1a;
        }

        .time-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .time-info {
            background: #f0f0f0;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            min-width: 130px;
            text-align: center;
            color: #333;
        }

        .status-badge {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
        }

        .status-badge.open {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .btn-control {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-control:active {
            transform: scale(0.95);
            background: #e0e0e0;
        }

        .btn-next-day {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Dashboard */
        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-card {
            background: #ffffff;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e5e5e5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .stat-card.cash-card {
            border-left: 4px solid #10b981;
        }

        .stat-card.brokerage-card {
            border-left: 4px solid #3b82f6;
        }

        .stat-label {
            font-size: 13px;
            color: #888888;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
            word-break: break-all;
        }

        .announcement-banner {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .announcement-text {
            font-size: 14px;
            color: #666;
        }

        .announcement-text strong {
            color: #1a1a1a;
        }

        .announcement-arrow {
            color: #999;
            font-size: 18px;
        }

        .positive { color: #ef4444; }
        .negative { color: #3b82f6; }

        /* Content Panels */
        .content-panel {
            display: none;
            min-height: calc(100vh - 250px);
        }

        .content-panel.active {
            display: block;
        }

        /* Stock List */
        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .filters::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            background: #e8e8e8;
            color: #666;
            border: none;
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            flex-shrink: 0;
            font-weight: 500;
        }

        .filter-btn.active {
            background: #2196F3;
            color: white;
        }

        .stock-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e5e5e5;
        }

        .stock-item {
            background: #ffffff;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .stock-item:last-child {
            border-bottom: none;
        }

        .stock-item:active {
            background: #f8f8f8;
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .stock-logo {
            width: 40px;
            height: 40px;
            background: #e8e8e8;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #999;
            flex-shrink: 0;
        }

        .stock-details {
            flex: 1;
        }

        .stock-name {
            font-weight: 600;
            font-size: 15px;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .stock-ticker {
            font-size: 12px;
            color: #888888;
        }

        .stock-price {
            text-align: right;
            min-width: 100px;
        }

        .price {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #1a1a1a;
        }

        .change {
            font-size: 12px;
            font-weight: 600;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: flex-end;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 10;
        }

        .modal-close {
            background: none;
            border: none;
            color: #999;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:active {
            background: #f0f0f0;
        }

        .modal-body {
            padding: 20px;
        }

        .stock-detail-header {
            margin-bottom: 20px;
        }

        .detail-price {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .mini-chart {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            height: 180px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            position: relative;
        }

        .candle {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            height: 100%;
        }

        .candle-wick {
            width: 1px;
            background: #999;
            position: absolute;
        }

        .candle-body {
            width: 70%;
            min-height: 2px;
            position: absolute;
            z-index: 1;
            border-radius: 1px;
        }

        .candle-body.up {
            background: #ef4444;
            border: 1px solid #ef4444;
        }

        .candle-body.down {
            background: #3b82f6;
            border: 1px solid #3b82f6;
        }

        .holding-info {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .holding-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
        }

        .trade-section {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .trade-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .disabled-message {
            text-align: center;
            color: #888;
            font-size: 14px;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .trade-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .trade-info-label {
            color: #888;
        }

        .trade-info-value {
            font-weight: 600;
            color: #333;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
        }

        .input-display {
            width: 100%;
            background: #ffffff;
            border: 2px solid #e5e5e5;
            color: #1a1a1a;
            padding: 12px;
            border-radius: 8px;
            font-size: 20px;
            text-align: right;
            font-weight: 600;
            cursor: pointer;
            min-height: 50px;
        }

        .input-display:active {
            border-color: #3b82f6;
        }

        .input-display.empty {
            color: #ccc;
            font-size: 16px;
            font-weight: 400;
        }

        .trade-estimate {
            background: #ffffff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e5e5e5;
        }

        .estimate-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            color: #666;
        }

        .estimate-row:last-child {
            margin-bottom: 0;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }

        .trade-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-trade {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-trade:active {
            transform: scale(0.98);
        }

        .btn-buy {
            background: #ef4444;
            color: white;
        }

        .btn-sell {
            background: #3b82f6;
            color: white;
        }

        .btn-trade:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Numpad Modal */
        .numpad-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: flex-end;
        }

        .numpad-modal.active {
            display: flex;
        }

        .numpad-content {
            background: #ffffff;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 24px 20px;
            animation: slideUp 0.3s ease;
        }

        .numpad-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .numpad-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .numpad-display-area {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .numpad-input-text {
            font-size: 28px;
            color: #cccccc;
            margin-bottom: 8px;
        }

        .numpad-input-text.has-value {
            color: #333333;
            font-weight: 600;
        }

        .numpad-sub-text {
            font-size: 14px;
            color: #999999;
        }

        .numpad-info {
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            color: #666;
        }

        .info-value {
            font-weight: 600;
            color: #333;
        }

        .quick-buttons {
            display: flex;
            gap: 8px;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .quick-btn {
            flex: 1;
            padding: 10px 4px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #ffffff;
            font-size: 13px;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:active {
            background: #f5f5f5;
            transform: scale(0.95);
        }

        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 16px 0;
        }

        .numpad-btn {
            background: transparent;
            border: none;
            padding: 20px;
            font-size: 24px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .numpad-btn:active {
            background: #f0f0f0;
            transform: scale(0.95);
        }

        .numpad-btn.text-btn {
            font-size: 14px;
            color: #666;
        }

        .numpad-btn.backspace {
            color: #666;
        }

        .numpad-actions {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            padding-top: 16px;
        }

        .btn-numpad-cancel {
            background: #f5f5f5;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
        }

        .btn-numpad-cancel:active {
            background: #e8e8e8;
        }

        .btn-numpad-confirm {
            background: #2196F3;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
        }

        .btn-numpad-confirm:active {
            background: #1976D2;
        }

        /* News */
        .news-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .news-item {
            background: #ffffff;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e5e5e5;
            border-left: 4px solid #3b82f6;
        }

        .news-item.company { border-left-color: #3b82f6; }
        .news-item.sector { border-left-color: #8b5cf6; }
        .news-item.market { border-left-color: #f59e0b; }

        .news-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 11px;
            color: #888;
        }

        .news-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .news-description {
            font-size: 13px;
            color: #888;
            line-height: 1.5;
        }

        .news-impact {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }

        .impact-positive {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .impact-negative {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        /* Portfolio */
        .portfolio-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .portfolio-item {
            background: #ffffff;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e5e5e5;
            cursor: pointer;
            transition: all 0.2s;
        }

        .portfolio-item:active {
            background: #f8f8f8;
        }

        .portfolio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .portfolio-name {
            font-weight: 600;
            font-size: 15px;
            color: #1a1a1a;
        }

        .portfolio-ticker {
            font-size: 11px;
            color: #888;
        }

        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .portfolio-stat {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 8px;
        }

        .portfolio-label {
            font-size: 10px;
            color: #888;
            margin-bottom: 4px;
        }

        .portfolio-value {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .portfolio-value.positive {
            color: #ef4444;
        }

        .portfolio-value.negative {
            color: #3b82f6;
        }

        .portfolio-ticker.positive {
            color: #ef4444;
        }

        .portfolio-ticker.negative {
            color: #3b82f6;
        }

        /* Account */
        .account-section {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #e5e5e5;
        }

        .section-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 15px;
            color: #1a1a1a;
        }

        .btn-full {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:active {
            background: #2563eb;
            transform: scale(0.98);
        }

        /* Confirm Modal */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-content {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            max-width: 350px;
            width: 100%;
            animation: scaleIn 0.2s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .confirm-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 12px;
            color: #1a1a1a;
        }

        .confirm-message {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn-confirm {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .btn-ok {
            background: #3b82f6;
            color: white;
        }

        /* GNB */
        .gnb {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            border-top: 1px solid #e5e5e5;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .gnb-item {
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            color: #999999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .gnb-item:active {
            background: #f8f8f8;
        }

        .gnb-item.active {
            color: #2196F3;
        }

        .gnb-icon {
            font-size: 20px;
        }

        .gnb-label {
            font-size: 10px;
            font-weight: 600;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 90%;
            text-align: center;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            color: #888;
            text-align: center;
            padding: 40px 20px;
            font-size: 14px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        ::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">STOCKER</div>
            <div class="time-controls">
                <div class="time-info" id="timeDisplay">1Ïùº 08:00</div>
                <button class="btn-control" id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è</button>
                <button class="btn-next-day" id="nextDayBtn" onclick="nextDay()" style="display: none;">Îã§Ïùå ÎÇ†</button>
            </div>
        </div>
    </div>

    <!-- Container -->
    <div class="container">
        <!-- Dashboard -->
        <div class="dashboard">
            <div class="dashboard-cards">
                <div class="stat-card cash-card">
                    <div class="stat-label">üíµ ÌòÑÍ∏à</div>
                    <div class="stat-value" id="cashDisplay">1,000,000Ïõê</div>
                </div>
                <div class="stat-card brokerage-card">
                    <div class="stat-label">üí∞ ÏòàÏàòÍ∏à</div>
                    <div class="stat-value" id="brokerageDisplay">0Ïõê</div>
                </div>
            </div>
            <div class="announcement-banner">
                <div class="announcement-text">
                    <strong>Í≥µÏßÄ:</strong> Ï¶ùÍ∂åÍ±∞ÎûòÏÜå Í∞úÏû• ÏãúÍ∞ÑÏùÄ Ïò§Ï†Ñ 9ÏãúÏûÖÎãàÎã§.
                </div>
                <div class="announcement-arrow">‚Ä∫</div>
            </div>
        </div>

        <!-- Content Panels -->
        <div id="stocksPanel" class="content-panel active">
            <div class="filters" id="filterButtons"></div>
            <div id="stockList" class="stock-list"></div>
        </div>

        <div id="portfolioPanel" class="content-panel">
            <div id="portfolioList" class="portfolio-list"></div>
        </div>

        <div id="newsPanel" class="content-panel">
            <div id="newsList" class="news-list"></div>
        </div>

        <div id="investPanel" class="content-panel">
            <div class="empty-state">
                üèóÔ∏è Î∂ÄÎèôÏÇ∞, Ï∞®Îüâ, ÏÇ¨ÏπòÌíà Îì±<br>Ï∂îÍ∞Ä Ìà¨Ïûê ÏÉÅÌíà Ï§ÄÎπÑ Ï§ë
            </div>
        </div>

        <div id="accountPanel" class="content-panel">
            <div class="account-section">
                <div class="section-title">üí∞ Í≥ÑÏ¢å Ïù¥Ï≤¥</div>
                <div class="input-group">
                    <label>Ïù¥Ï≤¥ Í∏àÏï°</label>
                    <div class="input-display empty" id="transferDisplay" onclick="showTransferNumpad()">Í∏àÏï° ÏûÖÎ†•</div>
                </div>
                <button class="btn-full btn-primary" onclick="showTransferConfirm('toBrokerage')">
                    ÌòÑÍ∏à ‚Üí ÏòàÏàòÍ∏à
                </button>
                <button class="btn-full btn-primary" onclick="showTransferConfirm('toCash')">
                    ÏòàÏàòÍ∏à ‚Üí ÌòÑÍ∏à
                </button>
            </div>
        </div>
    </div>

    <!-- Stock Detail Modal -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="modalStockName" style="font-size: 20px; margin-bottom: 4px; color: #1a1a1a;"></h2>
                    <div id="modalStockTicker" style="color: #888; font-size: 12px;"></div>
                </div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="stock-detail-header">
                    <div class="detail-price" id="modalStockPrice"></div>
                    <div id="modalStockChange"></div>
                </div>

                <div class="mini-chart" id="miniChart"></div>

                <div class="holding-info" id="holdingInfo" style="display: none;"></div>

                <div id="tradeDisabledMessage" class="disabled-message" style="display: none;">
                    ‚è∞ Í±∞ÎûòÏÜåÍ∞Ä ÌèêÏû•ÎêòÏñ¥ Ï£ºÏãù Í±∞ÎûòÍ∞Ä Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§
                </div>

                <div class="trade-section" id="tradeSection">
                    <div class="trade-info-row">
                        <span class="trade-info-label">ÏòàÏàòÍ∏à ÏûîÍ≥†</span>
                        <span class="trade-info-value" id="tradeBalance">0Ïõê</span>
                    </div>
                    <div class="trade-info-row">
                        <span class="trade-info-label">ÏµúÎåÄ Íµ¨Îß§ Í∞ÄÎä•</span>
                        <span class="trade-info-value" id="maxBuyQty">0Ï£º</span>
                    </div>

                    <div class="input-group">
                        <label>Í±∞Îûò ÏàòÎüâ</label>
                        <div class="input-display empty" id="qtyDisplay" onclick="showNumpad()">ÏàòÎüâ ÏûÖÎ†•</div>
                    </div>

                    <div class="trade-estimate" id="tradeEstimate" style="display: none;">
                        <div class="estimate-row">
                            <span>Í±∞Îûò Í∏àÏï°</span>
                            <span id="estimateAmount">-</span>
                        </div>
                        <div class="estimate-row">
                            <span>ÏàòÏàòÎ£å</span>
                            <span id="estimateFee">-</span>
                        </div>
                        <div class="estimate-row">
                            <span>Ï¥ù ÌïÑÏöî Í∏àÏï° (Îß§Ïàò)</span>
                            <span id="estimateTotal">-</span>
                        </div>
                    </div>

                    <div class="trade-buttons">
                        <button class="btn-trade btn-buy" onclick="executeTrade('buy')">Îß§Ïàò</button>
                        <button class="btn-trade btn-sell" onclick="executeTrade('sell')">Îß§ÎèÑ</button>
                    </div>
                </div>

                <h3 style="margin: 20px 0 10px; font-size: 16px; color: #1a1a1a;">Í¥ÄÎ†® Îâ¥Ïä§</h3>
                <div id="modalNewsList" class="news-list"></div>
            </div>
        </div>
    </div>

    <!-- Numpad Modal -->
    <div id="numpadModal" class="numpad-modal">
        <div class="numpad-content">
            <div class="numpad-header">
                <span class="numpad-title" id="numpadTitle">Íµ¨Îß§ ÏàòÎüâ</span>
            </div>

            <div class="numpad-display-area">
                <div class="numpad-input-text" id="numpadDisplay">Íµ¨Îß§ ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî</div>
                <div class="numpad-sub-text" id="numpadSubText">ÏòàÏÉÅ Í∏àÏï°</div>
            </div>

            <div class="numpad-info" id="numpadInfo">
                <div class="info-row">
                    <span>Ï£ºÎ¨∏ Í∞ÄÎä• Í∏àÏï°</span>
                    <span class="info-value" id="numpadAvailableAmount">0Ïõê</span>
                </div>
                <div class="info-row">
                    <span>Íµ¨Îß§ Í∞ÄÎä• ÏàòÎüâ</span>
                    <span class="info-value" id="numpadMaxQty">ÏµúÎåÄ 0Ï£º</span>
                </div>
            </div>

            <div class="quick-buttons" id="quickButtons">
                <button class="quick-btn" onclick="addQuickAmount(10)">+10</button>
                <button class="quick-btn" onclick="addQuickAmount(100)">+100</button>
                <button class="quick-btn" onclick="addQuickAmount(1000)">+1,000</button>
                <button class="quick-btn" onclick="addQuickAmount(10000)">+10,000</button>
                <button class="quick-btn" onclick="addQuickAmount('max')">ÏµúÎåÄ</button>
            </div>

            <div class="numpad-grid">
                <button class="numpad-btn" onclick="addDigit('1')">1</button>
                <button class="numpad-btn" onclick="addDigit('2')">2</button>
                <button class="numpad-btn" onclick="addDigit('3')">3</button>
                <button class="numpad-btn" onclick="addDigit('4')">4</button>
                <button class="numpad-btn" onclick="addDigit('5')">5</button>
                <button class="numpad-btn" onclick="addDigit('6')">6</button>
                <button class="numpad-btn" onclick="addDigit('7')">7</button>
                <button class="numpad-btn" onclick="addDigit('8')">8</button>
                <button class="numpad-btn" onclick="addDigit('9')">9</button>
                <button class="numpad-btn text-btn" onclick="clearNumpad()">Ï†ÑÏ≤¥ÏÇ≠Ï†ú</button>
                <button class="numpad-btn" onclick="addDigit('0')">0</button>
                <button class="numpad-btn backspace" onclick="backspace()">‚å´</button>
            </div>

            <div class="numpad-actions">
                <button class="btn-numpad-cancel" onclick="closeNumpad()">Ï∑®ÏÜå</button>
                <button class="btn-numpad-confirm" id="numpadConfirmBtn" onclick="confirmNumpad()">Íµ¨Îß§ÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-title" id="confirmTitle"></div>
            <div class="confirm-message" id="confirmMessage"></div>
            <div class="confirm-buttons">
                <button class="btn-confirm btn-cancel" onclick="closeConfirm()">Ï∑®ÏÜå</button>
                <button class="btn-confirm btn-ok" onclick="confirmAction()">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <!-- GNB -->
    <div class="gnb">
        <button class="gnb-item active" onclick="switchTab('stocks')">
            <div class="gnb-icon">üè†</div>
            <div class="gnb-label">Ï¶ùÍ∂åÍ±∞ÎûòÏÜå</div>
        </button>
        <button class="gnb-item" onclick="switchTab('invest')">
            <div class="gnb-icon">üìä</div>
            <div class="gnb-label">Ìà¨Ïûê</div>
        </button>
        <button class="gnb-item" onclick="switchTab('portfolio')">
            <div class="gnb-icon">üíº</div>
            <div class="gnb-label">Ìè¨Ìä∏Ìè¥Î¶¨Ïò§</div>
        </button>
        <button class="gnb-item" onclick="switchTab('news')">
            <div class="gnb-icon">üì∞</div>
            <div class="gnb-label">ÏÜåÏãù</div>
        </button>
        <button class="gnb-item" onclick="switchTab('account')">
            <div class="gnb-icon">üë§</div>
            <div class="gnb-label">ÎÇ¥ Ï†ïÎ≥¥</div>
        </button>
    </div>

    <script>
        // Game State
        const gameState = {
            day: 1,
            timeMinutes: 480,
            cash: 1000000,
            brokerageCash: 0,
            portfolio: [],
            market: {
                companies: [],
                prices: {},
                previousClosePrices: {},
                candleHistory: {},
                marketMood: 0
            },
            news: [],
            newsCache: {
                company: {},  // { companyId: [news items] }
                sector: {},   // { sector: [news items] }
                market: []
            },
            selectedSector: 'Ï†ÑÏ≤¥',
            isPaused: false,
            isClosed: false
        };

        let gameTimer = null;
        let currentStockId = null;
        let confirmCallback = null;
        let numpadValue = '';
        let numpadMode = 'trade'; // 'trade' or 'transfer'
        let lastTickTime = 0;
        const TICK_INTERVAL = 2000; // 2 seconds
        let activeToasts = [];
        const MAX_TOASTS = 3;

        // Company Data (Î≥ÄÎèôÏÑ± 1/3Î°ú Í∞êÏÜå)
        const companyData = [{"id":1,"name":"Î∞îÎÇòÎÇò","ticker":"BANN","sector":"ÌÖåÌÅ¨/IT","initialPrice":85000,"baseVolatilityPerTick":0.0022},{"id":2,"name":"ÏÉò ÏÜîÎ£®ÏÖò","ticker":"SSOL","sector":"ÌÖåÌÅ¨/IT","initialPrice":72000,"baseVolatilityPerTick":0.0022},{"id":3,"name":"ÏÜåÎØ∏ÌÖç","ticker":"SOMI","sector":"ÌÖåÌÅ¨/IT","initialPrice":125000,"baseVolatilityPerTick":0.0022},{"id":4,"name":"ÏÑúÎãà","ticker":"SUNY","sector":"ÌÖåÌÅ¨/IT","initialPrice":45000,"baseVolatilityPerTick":0.0044},{"id":5,"name":"ÌùêÏõ®Ïù¥","ticker":"HWEI","sector":"ÌÖåÌÅ¨/IT","initialPrice":32000,"baseVolatilityPerTick":0.0044},{"id":6,"name":"Cloz AI","ticker":"CLZA","sector":"ÌÖåÌÅ¨/IT","initialPrice":150000,"baseVolatilityPerTick":0.0081},{"id":7,"name":"Î£®Ìä∏ ÌÖåÌÅ¨ÎÜÄÎ°úÏßÄ","ticker":"RRTN","sector":"ÌÖåÌÅ¨/IT","initialPrice":58000,"baseVolatilityPerTick":0.0128},{"id":8,"name":"ZPT","ticker":"ZPTT","sector":"ÌÖåÌÅ¨/IT","initialPrice":210000,"baseVolatilityPerTick":0.0081},{"id":9,"name":"Î™®Î•¥Î™®Ìä∏Ï†úÏïΩ","ticker":"MRMT","sector":"Î∞îÏù¥Ïò§/Ï†úÏïΩ","initialPrice":120000,"baseVolatilityPerTick":0.0117},{"id":10,"name":"Î¨¥ÌïúÏ†úÏïΩ","ticker":"MUHN","sector":"Î∞îÏù¥Ïò§/Ï†úÏïΩ","initialPrice":88000,"baseVolatilityPerTick":0.0117},{"id":11,"name":"HBM Î∞îÏù¥Ïò§","ticker":"HBMB","sector":"Î∞îÏù¥Ïò§/Ï†úÏïΩ","initialPrice":45000,"baseVolatilityPerTick":0.0187},{"id":12,"name":"Î°±Ìó§Ïñ¥Ïó∞Íµ¨ÏÜå","ticker":"LHRL","sector":"Î∞îÏù¥Ïò§/Ï†úÏïΩ","initialPrice":23000,"baseVolatilityPerTick":0.0187},{"id":13,"name":"ÏïàÏ£ºÍ±∞Ï†úÏïΩ","ticker":"AZGB","sector":"Î∞îÏù¥Ïò§/Ï†úÏïΩ","initialPrice":65000,"baseVolatilityPerTick":0.0187},{"id":14,"name":"ÌïúÎåÄÏûêÎèôÏ∞®","ticker":"HAND","sector":"ÏûêÎèôÏ∞®/ÏóêÎÑàÏßÄ","initialPrice":190000,"baseVolatilityPerTick":0.002},{"id":15,"name":"Í∏∞Ïñ¥ÏûêÎèôÏ∞®","ticker":"GEAR","sector":"ÏûêÎèôÏ∞®/ÏóêÎÑàÏßÄ","initialPrice":85000,"baseVolatilityPerTick":0.002},{"id":16,"name":"ÌïúÍµ≠ÏûêÎèôÏ∞®","ticker":"HGCA","sector":"ÏûêÎèôÏ∞®/ÏóêÎÑàÏßÄ","initialPrice":12000,"baseVolatilityPerTick":0.002},{"id":17,"name":"Ïù∏ÎèÑÏò§Ïùº","ticker":"INDO","sector":"ÏûêÎèôÏ∞®/ÏóêÎÑàÏßÄ","initialPrice":68000,"baseVolatilityPerTick":0.004},{"id":18,"name":"ÎßåÏä¨ÎùºÏò§Ïùº","ticker":"MSLO","sector":"ÏûêÎèôÏ∞®/ÏóêÎÑàÏßÄ","initialPrice":110000,"baseVolatilityPerTick":0.004},{"id":19,"name":"Ìò∏Î•¥Î™¨ÌîåÎùºÏä§Ìã±","ticker":"HMPL","sector":"ÏûêÎèôÏ∞®/ÏóêÎÑàÏßÄ","initialPrice":150000,"baseVolatilityPerTick":0.004},{"id":20,"name":"ÎëêÎåÄÏ§ëÍ≥µÏóÖ","ticker":"DDHV","sector":"ÏûêÎèôÏ∞®/ÏóêÎÑàÏßÄ","initialPrice":18000,"baseVolatilityPerTick":0.002},{"id":21,"name":"Î¨¥Î†•Ï§ëÍ≥µÏóÖ","ticker":"MRHV","sector":"ÏûêÎèôÏ∞®/ÏóêÎÑàÏßÄ","initialPrice":22000,"baseVolatilityPerTick":0.0073},{"id":22,"name":"Ïï†ÌîåÎ¶≠Ïä§","ticker":"APLX","sector":"ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","initialPrice":420000,"baseVolatilityPerTick":0.0028},{"id":23,"name":"Ìã∞Î∏åÏûâ","ticker":"TVNG","sector":"ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","initialPrice":85000,"baseVolatilityPerTick":0.0103},{"id":24,"name":"ÏÇ¨Í≥ºTV","ticker":"APTV","sector":"ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","initialPrice":125000,"baseVolatilityPerTick":0.0056},{"id":25,"name":"PJYÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","ticker":"PJYE","sector":"ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","initialPrice":68000,"baseVolatilityPerTick":0.0103},{"id":26,"name":"MSÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","ticker":"MSET","sector":"ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","initialPrice":150000,"baseVolatilityPerTick":0.0103},{"id":27,"name":"ÌïòÏù¥ÌååÏù¥Î∏å","ticker":"HIFI","sector":"ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","initialPrice":250000,"baseVolatilityPerTick":0.0056},{"id":28,"name":"22ÏÑ∏Í∏∞ ÏòÅÌôîÏÇ¨","ticker":"EEMV","sector":"ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","initialPrice":8000,"baseVolatilityPerTick":0.0163},{"id":29,"name":"Î∏åÎùºÎçîÏä§","ticker":"BRTS","sector":"ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","initialPrice":5500,"baseVolatilityPerTick":0.0163},{"id":30,"name":"Ï∫òÎ¶¨Ìè¨ÎãàÏïÑÎ¨¥ÎπÑ","ticker":"CLMV","sector":"ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏","initialPrice":12000,"baseVolatilityPerTick":0.0163},{"id":31,"name":"ÎßàÎßàÏ°¥","ticker":"MMZN","sector":"ÏÉùÌôú/ÏãùÌíà","initialPrice":180000,"baseVolatilityPerTick":0.0016},{"id":32,"name":"ÏΩîÏä§Ìä∏Ïπ¥","ticker":"CSTK","sector":"ÏÉùÌôú/ÏãùÌíà","initialPrice":350000,"baseVolatilityPerTick":0.0016},{"id":33,"name":"ÏúÑÎßàÌä∏","ticker":"WEMA","sector":"ÏÉùÌôú/ÏãùÌíà","initialPrice":45000,"baseVolatilityPerTick":0.0059},{"id":34,"name":"Í≥∞Ìå°","ticker":"GOMP","sector":"ÏÉùÌôú/ÏãùÌíà","initialPrice":28000,"baseVolatilityPerTick":0.0032},{"id":35,"name":"Ïì∞ÏúΩÏáºÌïë","ticker":"SSUK","sector":"ÏÉùÌôú/ÏãùÌíà","initialPrice":150000,"baseVolatilityPerTick":0.0059},{"id":36,"name":"ÏÜåÎÖÑÎÇòÎùº","ticker":"SNNA","sector":"ÏÉùÌôú/ÏãùÌíà","initialPrice":3500,"baseVolatilityPerTick":0.0093},{"id":37,"name":"Ïú†Ïã†ÏÇ¨","ticker":"YUSS","sector":"ÏÉùÌôú/ÏãùÌíà","initialPrice":120000,"baseVolatilityPerTick":0.0059},{"id":38,"name":"Î∏îÎ£®ÎùºÏù¥ÎÑà","ticker":"BLLN","sector":"ÍµêÌÜµ/Ìï≠Í≥µ","initialPrice":28000,"baseVolatilityPerTick":0.0024},{"id":39,"name":"ÏôÄÏù¥ÎùºÎÖ∏Ìï≠Í≥µ","ticker":"WRAR","sector":"ÍµêÌÜµ/Ìï≠Í≥µ","initialPrice":22000,"baseVolatilityPerTick":0.0048},{"id":40,"name":"ÎÖ∏ÎùºÌÉÄÌï≠Í≥µ","ticker":"NORA","sector":"ÍµêÌÜµ/Ìï≠Í≥µ","initialPrice":12000,"baseVolatilityPerTick":0.014},{"id":41,"name":"ZWAY","ticker":"ZWAY","sector":"ÍµêÌÜµ/Ìï≠Í≥µ","initialPrice":9500,"baseVolatilityPerTick":0.014},{"id":42,"name":"Ï≤≠Î∞îÏßÄÏóêÏñ¥","ticker":"JEAN","sector":"ÍµêÌÜµ/Ìï≠Í≥µ","initialPrice":18000,"baseVolatilityPerTick":0.014},{"id":43,"name":"Í¥ëÏÜçÍ≥†ÏÜçÏ≤†ÎèÑ","ticker":"GSRW","sector":"ÍµêÌÜµ/Ìï≠Í≥µ","initialPrice":45000,"baseVolatilityPerTick":0.0048},{"id":44,"name":"ÏÑúÎ∏åÏõ®Ïù¥Ïñ¥","ticker":"SBWR","sector":"ÍµêÌÜµ/Ìï≠Í≥µ","initialPrice":5000,"baseVolatilityPerTick":0.0048}];

        // News Templates (ÏòÅÌñ•Î†• Í∞êÏÜå)
        const newsTemplates = {
            company: [
                { title: "Ïã†Ï†úÌíà Ï∂úÏãú Î∞úÌëú", impact: 0.015, duration: 15 },
                { title: "Î∂ÑÍ∏∞ Ïã§Ï†Å Ìò∏Ï°∞", impact: 0.012, duration: 10 },
                { title: "CEO ÍµêÏ≤¥ Î∞úÌëú", impact: -0.01, duration: 10 },
                { title: "ÎåÄÍ∑úÎ™® Ìà¨Ïûê Ïú†Ïπò", impact: 0.02, duration: 15 },
                { title: "ÏòÅÏóÖÏù¥Ïùµ Í∞êÏÜå", impact: -0.015, duration: 10 },
                { title: "Ïã†Í∑ú ÏÇ¨ÏóÖ ÏßÑÏ∂ú", impact: 0.01, duration: 15 },
                { title: "Î¶¨ÏΩú ÏÇ¨ÌÉú Î∞úÏÉù", impact: -0.025, duration: 20 }
            ],
            sector: [
                { title: "ÏóÖÏ¢Ö Ï†ÑÎßù ÏÉÅÌñ•", impact: 0.01, duration: 15 },
                { title: "Í∑úÏ†ú Í∞ïÌôî ÏòàÏ†ï", impact: -0.012, duration: 20 },
                { title: "ÏóÖÍ≥Ñ Ìò∏Ìô© ÏßÄÏÜç", impact: 0.008, duration: 10 },
                { title: "Í≤ΩÏüÅ Ïã¨Ìôî", impact: -0.008, duration: 15 }
            ],
            market: [
                { title: "Í∏àÎ¶¨ Ïù∏Ìïò Îã®Ìñâ", impact: 0.015, duration: 25 },
                { title: "Í≤ΩÍ∏∞ Ïπ®Ï≤¥ Ïö∞Î†§", impact: -0.02, duration: 25 },
                { title: "Ïô∏Íµ≠Ïù∏ Îß§ÏàòÏÑ∏ Ï¶ùÍ∞Ä", impact: 0.01, duration: 15 },
                { title: "Í∏ÄÎ°úÎ≤å Î∂àÌôïÏã§ÏÑ± ÌôïÎåÄ", impact: -0.012, duration: 20 }
            ]
        };

        // Initialize
        function init() {
            gameState.market.companies = companyData.map(c => ({
                ...c,
                newsTimes: []
            }));

            gameState.market.companies.forEach(company => {
                gameState.market.prices[company.id] = company.initialPrice;
                gameState.market.previousClosePrices[company.id] = company.initialPrice;
                gameState.market.candleHistory[company.id] = [{
                    open: company.initialPrice,
                    high: company.initialPrice,
                    low: company.initialPrice,
                    close: company.initialPrice
                }];
            });

            renderFilters();
            renderStockList();
            updateDisplay();
            setupEventDelegation();
            startGameTimer();
        }

        // Setup Event Delegation
        function setupEventDelegation() {
            // Stock list click delegation
            document.getElementById('stockList').addEventListener('click', (e) => {
                const stockItem = e.target.closest('.stock-item');
                if (stockItem) {
                    const companyId = parseInt(stockItem.dataset.companyId);
                    if (companyId) openStockDetail(companyId);
                }
            });

            // Portfolio list click delegation
            document.getElementById('portfolioList').addEventListener('click', (e) => {
                const portfolioItem = e.target.closest('.portfolio-item');
                if (portfolioItem) {
                    const companyId = parseInt(portfolioItem.dataset.companyId);
                    if (companyId) openStockDetail(companyId);
                }
            });
        }

        // Game Timer
        function startGameTimer() {
            function gameLoop(timestamp) {
                if (timestamp - lastTickTime >= TICK_INTERVAL) {
                    if (!gameState.isPaused && !gameState.isClosed) {
                        gameTick();
                    }
                    lastTickTime = timestamp;
                }
                gameTimer = requestAnimationFrame(gameLoop);
            }

            if (gameTimer) cancelAnimationFrame(gameTimer);
            lastTickTime = performance.now();
            gameTimer = requestAnimationFrame(gameLoop);
        }

        function gameTick() {
            gameState.timeMinutes += 5;

            if (gameState.timeMinutes === 540) {
                gameState.isClosed = false;
                showToast('üîî Í±∞ÎûòÏÜå Í∞úÏû•!');
            }

            if (gameState.timeMinutes > 930) {
                gameState.isClosed = true;
                gameState.timeMinutes = 930;

                // Ï†ÑÏùº Ï¢ÖÍ∞Ä Ï†ÄÏû•
                gameState.market.companies.forEach(company => {
                    gameState.market.previousClosePrices[company.id] = gameState.market.prices[company.id];
                });

                document.getElementById('nextDayBtn').style.display = 'block';
                document.getElementById('pauseBtn').style.display = 'none';
                showToast('üîî Í±∞ÎûòÏÜå ÌèêÏû•');
                return;
            }

            if (gameState.timeMinutes >= 540 && gameState.timeMinutes <= 930) {
                if (Math.random() < 0.1) {
                    generateNews();
                }

                gameState.market.marketMood += (Math.random() - 0.5) * 0.005;
                gameState.market.marketMood = Math.max(-0.03, Math.min(0.03, gameState.market.marketMood));

                // Lazy price updates: only update prices for visible/needed stocks
                const companiesToUpdate = new Set();

                // Always update stocks in portfolio
                gameState.portfolio.forEach(holding => {
                    const company = gameState.market.companies.find(c => c.id === holding.companyId);
                    if (company) companiesToUpdate.add(company);
                });

                // If stock modal is open, update that stock
                if (currentStockId) {
                    const company = gameState.market.companies.find(c => c.id === currentStockId);
                    if (company) companiesToUpdate.add(company);
                }

                // If stocks panel is active, update visible stocks
                if (document.getElementById('stocksPanel').classList.contains('active')) {
                    const visibleCompanies = gameState.selectedSector === 'Ï†ÑÏ≤¥' ?
                        gameState.market.companies :
                        gameState.market.companies.filter(c => c.sector === gameState.selectedSector);
                    visibleCompanies.forEach(company => companiesToUpdate.add(company));
                }

                // Update all identified companies
                companiesToUpdate.forEach(company => {
                    updatePrice(company);
                });
            }

            updateDisplay();
            if (document.getElementById('stocksPanel').classList.contains('active')) {
                renderStockList();
            }
        }

        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            document.getElementById('pauseBtn').textContent = gameState.isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
            showToast(gameState.isPaused ? '‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ' : '‚ñ∂Ô∏è Ïû¨ÏÉù');
        }

        function nextDay() {
            gameState.day++;
            gameState.timeMinutes = 480;
            gameState.isClosed = false;
            document.getElementById('nextDayBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'block';
            updateDisplay();
            showToast(`üìÖ Day ${gameState.day} ÏãúÏûë`);
        }

        // Update Display
        function updateDisplay() {
            const hours = Math.floor(gameState.timeMinutes / 60);
            const minutes = gameState.timeMinutes % 60;
            const timeStr = `${gameState.day}Ïùº ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

            document.getElementById('timeDisplay').textContent = gameState.isClosed ? `${gameState.day}Ïùº ÌèêÏû•` : timeStr;
            document.getElementById('cashDisplay').textContent = formatMoneyWon(gameState.cash);
            document.getElementById('brokerageDisplay').textContent = formatMoneyWon(gameState.brokerageCash);
        }

        function calculateStockValue() {
            return gameState.portfolio.reduce((sum, holding) => {
                const currentPrice = gameState.market.prices[holding.companyId];
                return sum + (currentPrice * holding.qty);
            }, 0);
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('ko-KR').format(Math.floor(amount)) + ' ‚Ç©';
        }

        function formatMoneyWon(amount) {
            return new Intl.NumberFormat('ko-KR').format(Math.floor(amount)) + 'Ïõê';
        }

        // Render Filters
        function renderFilters() {
            const sectors = ['Ï†ÑÏ≤¥', ...new Set(companyData.map(c => c.sector))];
            document.getElementById('filterButtons').innerHTML = sectors.map(sector =>
                `<button class="filter-btn ${sector === 'Ï†ÑÏ≤¥' ? 'active' : ''}" onclick="filterSector('${sector}')">${sector}</button>`
            ).join('');
        }

        function filterSector(sector) {
            gameState.selectedSector = sector;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === sector);
            });
            renderStockList();
        }

        // Render Stock List
        function renderStockList() {
            const container = document.getElementById('stockList');
            const filtered = gameState.selectedSector === 'Ï†ÑÏ≤¥' ?
                gameState.market.companies :
                gameState.market.companies.filter(c => c.sector === gameState.selectedSector);

            // Check if we need full re-render (sector change or initial render)
            const existingItems = container.querySelectorAll('.stock-item');
            const needsFullRender = existingItems.length !== filtered.length ||
                                   (existingItems.length > 0 &&
                                    parseInt(existingItems[0].dataset.companyId) !== filtered[0].id);

            if (needsFullRender) {
                // Full render when filter changes
                container.innerHTML = filtered.map(company => {
                    const firstLetter = company.name.charAt(0);

                    return `
                        <div class="stock-item" data-company-id="${company.id}">
                            <div class="stock-info">
                                <div class="stock-logo">${firstLetter}</div>
                                <div class="stock-details">
                                    <div class="stock-name">${company.name}</div>
                                    <div class="stock-ticker">${company.ticker}</div>
                                </div>
                            </div>
                            <div class="stock-price">
                                <div class="price" data-price></div>
                                <div class="change" data-change></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Update only prices and changes (always runs)
            filtered.forEach(company => {
                const item = container.querySelector(`[data-company-id="${company.id}"]`);
                if (!item) return;

                const price = gameState.market.prices[company.id];
                const prevClose = gameState.market.previousClosePrices[company.id];
                const change = ((price - prevClose) / prevClose * 100);
                const changeAmount = price - prevClose;

                const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : '';
                const changeSymbol = change > 0 ? '+' : '';

                const priceEl = item.querySelector('[data-price]');
                const changeEl = item.querySelector('[data-change]');

                if (priceEl) priceEl.textContent = formatMoneyWon(price);
                if (changeEl) {
                    changeEl.textContent = `${changeSymbol}${formatMoneyWon(changeAmount)} (${changeSymbol}${change.toFixed(2)}%)`;
                    changeEl.className = `change ${changeClass}`;
                }
            });
        }

        // Update Price
        function updatePrice(company) {
            const currentPrice = gameState.market.prices[company.id];
            const candleHistory = gameState.market.candleHistory[company.id];
            const currentCandle = candleHistory[candleHistory.length - 1];

            const decay = 180;
            let issueIndex = 0;
            company.newsTimes.forEach(newsTick => {
                const age = gameState.timeMinutes - newsTick;
                const weight = Math.exp(-age / decay);
                issueIndex += weight;
            });
            issueIndex = Math.min(issueIndex / 5, 1);

            const randomChange = (Math.random() - 0.5) * company.baseVolatilityPerTick * 2;
            const moodEffect = gameState.market.marketMood * 0.5;

            let newsEffect = 0;
            // Use cached news instead of filtering
            const activeNews = [
                ...(gameState.newsCache.company[company.id] || []),
                ...(gameState.newsCache.sector[company.sector] || []),
                ...gameState.newsCache.market
            ];

            activeNews.forEach(news => {
                if (news.timestampMinutes === gameState.timeMinutes) {
                    newsEffect += news.impactNow;
                }

                const ticksSinceNews = (gameState.timeMinutes - news.timestampMinutes) / 5;
                if (ticksSinceNews > 0 && ticksSinceNews <= news.impactDuration) {
                    newsEffect += news.impactPerTick;
                }
            });

            const totalChange = randomChange + moodEffect + newsEffect;
            const newPrice = Math.max(100, Math.floor(currentPrice * (1 + totalChange)));

            // Update candle data
            currentCandle.close = newPrice;
            currentCandle.high = Math.max(currentCandle.high, newPrice);
            currentCandle.low = Math.min(currentCandle.low, newPrice);

            gameState.market.prices[company.id] = newPrice;

            // Every 30 minutes (6 ticks), create new candle
            const ticksSinceOpen = (gameState.timeMinutes - 540) / 5;
            if (ticksSinceOpen > 0 && ticksSinceOpen % 6 === 0) {
                candleHistory.push({
                    open: newPrice,
                    high: newPrice,
                    low: newPrice,
                    close: newPrice
                });
            }

            if (candleHistory.length > 30) {
                candleHistory.shift();
            }
        }

        // Update News Cache
        function updateNewsCache() {
            gameState.newsCache.company = {};
            gameState.newsCache.sector = {};
            gameState.newsCache.market = [];

            gameState.news.forEach(n => {
                if (n.scope === 'company') {
                    if (!gameState.newsCache.company[n.targetId]) {
                        gameState.newsCache.company[n.targetId] = [];
                    }
                    gameState.newsCache.company[n.targetId].push(n);
                } else if (n.scope === 'sector') {
                    if (!gameState.newsCache.sector[n.targetId]) {
                        gameState.newsCache.sector[n.targetId] = [];
                    }
                    gameState.newsCache.sector[n.targetId].push(n);
                } else if (n.scope === 'market') {
                    gameState.newsCache.market.push(n);
                }
            });
        }

        // Generate News
        function generateNews() {
            const scopes = ['company', 'sector', 'market'];
            const scope = scopes[Math.floor(Math.random() * scopes.length)];

            let targetId, targetName;

            if (scope === 'company') {
                const company = gameState.market.companies[Math.floor(Math.random() * gameState.market.companies.length)];
                targetId = company.id;
                targetName = company.name;
                company.newsTimes.push(gameState.timeMinutes);
                if (company.newsTimes.length > 10) company.newsTimes.shift();
            } else if (scope === 'sector') {
                const sectors = [...new Set(gameState.market.companies.map(c => c.sector))];
                targetId = sectors[Math.floor(Math.random() * sectors.length)];
                targetName = targetId;
            } else {
                targetId = 'market';
                targetName = 'Ï†ÑÏ≤¥ ÏãúÏû•';
            }

            const templates = newsTemplates[scope];
            const template = templates[Math.floor(Math.random() * templates.length)];

            const news = {
                id: gameState.news.length + 1,
                timestampMinutes: gameState.timeMinutes,
                day: gameState.day,
                timeStr: formatTime(gameState.timeMinutes),
                title: template.title,
                description: `${targetName}Ïóê ÎåÄÌïú ${template.title.toLowerCase()} ÏÜåÏãù`,
                scope: scope,
                targetId: targetId,
                impactNow: template.impact,
                impactDuration: template.duration,
                impactPerTick: template.impact / template.duration * 0.3
            };

            gameState.news.unshift(news);
            if (gameState.news.length > 50) gameState.news.pop();

            // Update news cache
            updateNewsCache();
        }

        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // Open Stock Detail
        function openStockDetail(companyId) {
            currentStockId = companyId;
            const company = gameState.market.companies.find(c => c.id === companyId);
            const price = gameState.market.prices[companyId];
            const prevClose = gameState.market.previousClosePrices[companyId];
            const change = ((price - prevClose) / prevClose * 100);
            const changeAmount = price - prevClose;

            document.getElementById('modalStockName').textContent = company.name;
            document.getElementById('modalStockTicker').textContent = `${company.ticker} ¬∑ ${company.sector}`;
            document.getElementById('modalStockPrice').textContent = formatMoneyWon(price);

            const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : '';
            const changeSymbol = change > 0 ? '+' : '';
            document.getElementById('modalStockChange').innerHTML =
                `<span class="${changeClass}">${changeSymbol}${formatMoneyWon(changeAmount)} (${changeSymbol}${change.toFixed(2)}%)</span>`;

            renderMiniChart(gameState.market.candleHistory[companyId]);

            // Holding Info
            const holding = gameState.portfolio.find(h => h.companyId === companyId);
            if (holding) {
                const pnl = (price - holding.avgCost) * holding.qty;
                const pnlPercent = (pnl / (holding.avgCost * holding.qty)) * 100;
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';

                document.getElementById('holdingInfo').style.display = 'block';
                document.getElementById('holdingInfo').innerHTML = `
                    <div class="holding-row">
                        <span>Î≥¥Ïú† ÏàòÎüâ</span>
                        <span>${holding.qty.toLocaleString()}Ï£º</span>
                    </div>
                    <div class="holding-row">
                        <span>ÌèâÍ∑† Îß§ÏûÖÍ∞Ä</span>
                        <span>${formatMoneyWon(holding.avgCost)}</span>
                    </div>
                    <div class="holding-row">
                        <span>ÌèâÍ∞Ä ÏÜêÏùµ</span>
                        <span class="${pnlClass}">${formatMoneyWon(pnl)} (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)</span>
                    </div>
                `;
            } else {
                document.getElementById('holdingInfo').style.display = 'none';
            }

            // Trade Section
            const canTrade = !gameState.isClosed && !gameState.isPaused;
            if (canTrade) {
                document.getElementById('tradeDisabledMessage').style.display = 'none';
                document.getElementById('tradeSection').style.display = 'block';

                // Update balance and max buy
                document.getElementById('tradeBalance').textContent = formatMoneyWon(gameState.brokerageCash);
                const maxQty = Math.floor(gameState.brokerageCash / (price * 1.001));
                document.getElementById('maxBuyQty').textContent = maxQty.toLocaleString() + 'Ï£º';

                // Reset quantity input
                numpadValue = '';
                document.getElementById('qtyDisplay').textContent = 'ÏàòÎüâ ÏûÖÎ†•';
                document.getElementById('qtyDisplay').classList.add('empty');
                document.getElementById('tradeEstimate').style.display = 'none';
            } else {
                document.getElementById('tradeDisabledMessage').style.display = 'block';
                document.getElementById('tradeSection').style.display = 'none';
            }

            // Related News
            const relatedNews = gameState.news.filter(n =>
                n.scope === 'company' && n.targetId === companyId ||
                n.scope === 'sector' && n.targetId === company.sector ||
                n.scope === 'market'
            ).slice(0, 5);

            document.getElementById('modalNewsList').innerHTML = relatedNews.length ?
                relatedNews.map(news => createNewsHTML(news)).join('') :
                '<div class="empty-state">Í¥ÄÎ†® Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';

            document.getElementById('stockModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('stockModal').classList.remove('active');
            currentStockId = null;
        }

        function renderMiniChart(candleHistory) {
            const container = document.getElementById('miniChart');
            const recentCandles = candleHistory.slice(-20);

            // Optimize min/max calculation without intermediate arrays
            let min = Infinity;
            let max = -Infinity;
            for (const candle of recentCandles) {
                if (candle.high > max) max = candle.high;
                if (candle.low < min) min = candle.low;
            }
            const range = max - min || 1;

            container.innerHTML = recentCandles.map(candle => {
                const isUp = candle.close >= candle.open;
                const bodyTop = Math.max(candle.open, candle.close);
                const bodyBottom = Math.min(candle.open, candle.close);
                const bodyHeight = Math.max(((bodyTop - bodyBottom) / range) * 100, 1);
                const bodyBottomPos = ((bodyBottom - min) / range) * 100;

                const wickHeight = ((candle.high - candle.low) / range) * 100;
                const wickBottomPos = ((candle.low - min) / range) * 100;

                return `
                    <div class="candle">
                        <div class="candle-wick" style="height: ${wickHeight}%; bottom: ${wickBottomPos}%"></div>
                        <div class="candle-body ${isUp ? 'up' : 'down'}"
                             style="height: ${bodyHeight}%; bottom: ${bodyBottomPos}%"></div>
                    </div>
                `;
            }).join('');
        }

        // Numpad Functions
        function showNumpad() {
            if (gameState.isClosed || gameState.isPaused) return;
            numpadMode = 'trade';
            numpadValue = '';

            // Update numpad for trade mode
            document.getElementById('numpadTitle').textContent = 'Íµ¨Îß§ ÏàòÎüâ';
            document.getElementById('numpadDisplay').textContent = 'Íµ¨Îß§ ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
            document.getElementById('numpadDisplay').classList.remove('has-value');
            document.getElementById('numpadSubText').textContent = 'ÏòàÏÉÅ Í∏àÏï°';
            document.getElementById('numpadConfirmBtn').textContent = 'Íµ¨Îß§ÌïòÍ∏∞';

            // Show trade-specific elements
            document.getElementById('numpadInfo').style.display = 'block';
            document.getElementById('quickButtons').style.display = 'flex';

            // Update available amount and max qty
            const price = gameState.market.prices[currentStockId];
            const maxQty = Math.floor(gameState.brokerageCash / (price * 1.001));
            document.getElementById('numpadAvailableAmount').textContent = formatMoneyWon(gameState.brokerageCash);
            document.getElementById('numpadMaxQty').textContent = `ÏµúÎåÄ ${maxQty.toLocaleString()}Ï£º`;

            document.getElementById('numpadModal').classList.add('active');
        }

        function showTransferNumpad() {
            numpadMode = 'transfer';
            numpadValue = '';

            // Update numpad for transfer mode
            document.getElementById('numpadTitle').textContent = 'Ïù¥Ï≤¥ Í∏àÏï°';
            document.getElementById('numpadDisplay').textContent = 'Ïù¥Ï≤¥ Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
            document.getElementById('numpadDisplay').classList.remove('has-value');
            document.getElementById('numpadSubText').textContent = '';
            document.getElementById('numpadConfirmBtn').textContent = 'Ïù¥Ï≤¥ÌïòÍ∏∞';

            // Hide trade-specific elements
            document.getElementById('numpadInfo').style.display = 'none';
            document.getElementById('quickButtons').style.display = 'none';

            document.getElementById('numpadModal').classList.add('active');
        }

        function closeNumpad() {
            document.getElementById('numpadModal').classList.remove('active');
        }

        function addDigit(digit) {
            if (numpadValue === '' && digit === '0') return;
            if (numpadValue.length >= 10) return;

            numpadValue += digit;
            updateNumpadDisplay();
        }

        function clearNumpad() {
            numpadValue = '';
            updateNumpadDisplay();
        }

        function backspace() {
            numpadValue = numpadValue.slice(0, -1);
            updateNumpadDisplay();
        }

        function addQuickAmount(amount) {
            if (amount === 'max') {
                // Calculate max purchasable quantity
                const price = gameState.market.prices[currentStockId];
                const maxQty = Math.floor(gameState.brokerageCash / (price * 1.001));
                numpadValue = String(maxQty);
            } else {
                const currentValue = parseInt(numpadValue) || 0;
                numpadValue = String(currentValue + amount);
            }
            updateNumpadDisplay();
        }

        function updateNumpadDisplay() {
            const value = parseInt(numpadValue) || 0;
            const displayEl = document.getElementById('numpadDisplay');
            const subTextEl = document.getElementById('numpadSubText');

            if (value === 0) {
                if (numpadMode === 'trade') {
                    displayEl.textContent = 'Íµ¨Îß§ ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
                    subTextEl.textContent = 'ÏòàÏÉÅ Í∏àÏï°';
                } else {
                    displayEl.textContent = 'Ïù¥Ï≤¥ Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
                    subTextEl.textContent = '';
                }
                displayEl.classList.remove('has-value');
            } else {
                if (numpadMode === 'trade') {
                    displayEl.textContent = value.toLocaleString() + 'Ï£º';
                    const price = gameState.market.prices[currentStockId];
                    const totalAmount = price * value;
                    subTextEl.textContent = formatMoneyWon(totalAmount);
                } else {
                    displayEl.textContent = formatMoneyWon(value);
                    subTextEl.textContent = '';
                }
                displayEl.classList.add('has-value');
            }
        }

        function confirmNumpad() {
            const value = parseInt(numpadValue) || 0;

            if (numpadMode === 'trade') {
                if (value === 0) {
                    document.getElementById('qtyDisplay').textContent = 'ÏàòÎüâ ÏûÖÎ†•';
                    document.getElementById('qtyDisplay').classList.add('empty');
                    document.getElementById('tradeEstimate').style.display = 'none';
                } else {
                    document.getElementById('qtyDisplay').textContent = value.toLocaleString() + 'Ï£º';
                    document.getElementById('qtyDisplay').classList.remove('empty');
                    updateTradeEstimate(value);
                }
            } else if (numpadMode === 'transfer') {
                if (value === 0) {
                    document.getElementById('transferDisplay').textContent = 'Í∏àÏï° ÏûÖÎ†•';
                    document.getElementById('transferDisplay').classList.add('empty');
                } else {
                    document.getElementById('transferDisplay').textContent = formatMoneyWon(value);
                    document.getElementById('transferDisplay').classList.remove('empty');
                }
            }

            closeNumpad();
        }

        function updateTradeEstimate(qty) {
            const price = gameState.market.prices[currentStockId];
            const amount = price * qty;
            const fee = amount * 0.001;
            const total = amount + fee;

            document.getElementById('estimateAmount').textContent = formatMoneyWon(amount);
            document.getElementById('estimateFee').textContent = formatMoneyWon(fee);
            document.getElementById('estimateTotal').textContent = formatMoneyWon(total);
            document.getElementById('tradeEstimate').style.display = 'block';
        }

        // Execute Trade
        function executeTrade(type) {
            if (gameState.isClosed || gameState.isPaused) {
                showToast('Í±∞ÎûòÏÜåÍ∞Ä ÌèêÏû• Ï§ëÏù¥Í±∞ÎÇò ÏùºÏãúÏ†ïÏßÄ ÏÉÅÌÉúÏûÖÎãàÎã§');
                return;
            }

            const qtyText = document.getElementById('qtyDisplay').textContent;
            if (qtyText === 'ÏàòÎüâ ÏûÖÎ†•') {
                showToast('ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                return;
            }

            const qty = parseInt(qtyText.replace(/[^0-9]/g, ''));
            if (!qty || qty <= 0) {
                showToast('ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                return;
            }

            const price = gameState.market.prices[currentStockId];
            const amount = price * qty;

            if (type === 'buy') {
                const fee = amount * 0.001;
                const total = amount + fee;

                if (total > gameState.brokerageCash) {
                    showToast('ÏòàÏàòÍ∏àÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§');
                    return;
                }

                gameState.brokerageCash -= total;

                const holding = gameState.portfolio.find(h => h.companyId === currentStockId);
                if (holding) {
                    const totalQty = holding.qty + qty;
                    holding.avgCost = (holding.avgCost * holding.qty + price * qty) / totalQty;
                    holding.qty = totalQty;
                } else {
                    gameState.portfolio.push({
                        companyId: currentStockId,
                        qty: qty,
                        avgCost: price
                    });
                }

                showToast(`‚úÖ Îß§Ïàò ÏôÑÎ£å: ${qty}Ï£º`);
            } else {
                const holding = gameState.portfolio.find(h => h.companyId === currentStockId);
                if (!holding || holding.qty < qty) {
                    showToast('Î≥¥Ïú† ÏàòÎüâÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§');
                    return;
                }

                const fee = amount * 0.001;
                const tax = amount * 0.002;
                const realizedPnL = (price - holding.avgCost) * qty;

                let capitalGainsTax = 0;
                const holdingValue = price * holding.qty;
                if (holdingValue >= 1000000000) {
                    const taxRate = holdingValue >= 10000000000 ? 0.275 :
                                   holdingValue >= 5000000000 ? 0.242 : 0.22;
                    capitalGainsTax = Math.max(0, realizedPnL) * taxRate;
                }

                const total = amount - fee - tax - capitalGainsTax;
                gameState.brokerageCash += total;

                holding.qty -= qty;
                if (holding.qty === 0) {
                    gameState.portfolio = gameState.portfolio.filter(h => h.companyId !== currentStockId);
                }

                showToast(`‚úÖ Îß§ÎèÑ ÏôÑÎ£å: ${qty}Ï£º`);
            }

            updateDisplay();
            openStockDetail(currentStockId);
        }

        // Transfer Functions
        function showTransferConfirm(direction) {
            const displayText = document.getElementById('transferDisplay').textContent;
            if (displayText === 'Í∏àÏï° ÏûÖÎ†•') {
                showToast('Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                return;
            }

            const amount = parseInt(displayText.replace(/[^0-9]/g, ''));
            if (!amount || amount <= 0) {
                showToast('Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                return;
            }

            const directionText = direction === 'toBrokerage' ? 'ÌòÑÍ∏à ‚Üí ÏòàÏàòÍ∏à' : 'ÏòàÏàòÍ∏à ‚Üí ÌòÑÍ∏à';
            const available = direction === 'toBrokerage' ? gameState.cash : gameState.brokerageCash;

            if (amount > available) {
                showToast('ÏûîÏï°Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§');
                return;
            }

            document.getElementById('confirmTitle').textContent = 'Í≥ÑÏ¢å Ïù¥Ï≤¥ ÌôïÏù∏';
            document.getElementById('confirmMessage').innerHTML =
                `<strong>${formatMoneyWon(amount)}</strong>ÏùÑ(Î•º)<br>${directionText} Ïù¥Ï≤¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;

            confirmCallback = () => executeTransfer(direction, amount);
            document.getElementById('confirmModal').classList.add('active');
        }

        function executeTransfer(direction, amount) {
            if (direction === 'toBrokerage') {
                gameState.cash -= amount;
                gameState.brokerageCash += amount;
                showToast(`‚úÖ ÏòàÏàòÍ∏àÏúºÎ°ú ${formatMoneyWon(amount)} Ïù¥Ï≤¥`);
            } else {
                gameState.brokerageCash -= amount;
                gameState.cash += amount;
                showToast(`‚úÖ ÌòÑÍ∏àÏúºÎ°ú ${formatMoneyWon(amount)} Ïù¥Ï≤¥`);
            }

            document.getElementById('transferDisplay').textContent = 'Í∏àÏï° ÏûÖÎ†•';
            document.getElementById('transferDisplay').classList.add('empty');
            updateDisplay();
        }

        function confirmAction() {
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
            closeConfirm();
        }

        function closeConfirm() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        // Switch Tab
        function switchTab(tab) {
            document.querySelectorAll('.gnb-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));

            event.target.closest('.gnb-item').classList.add('active');
            document.getElementById(tab + 'Panel').classList.add('active');

            if (tab === 'portfolio') renderPortfolio();
            if (tab === 'news') renderNews();
        }

        // Render Portfolio
        function renderPortfolio() {
            const container = document.getElementById('portfolioList');

            if (gameState.portfolio.length === 0) {
                container.innerHTML = '<div class="empty-state">Î≥¥Ïú† Ï§ëÏù∏ Ï£ºÏãùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
                return;
            }

            // Check if we need full re-render (portfolio composition changed)
            const existingItems = container.querySelectorAll('.portfolio-item');
            const portfolioIds = gameState.portfolio.map(h => h.companyId).sort().join(',');
            const existingIds = Array.from(existingItems).map(el => el.dataset.companyId).sort().join(',');
            const needsFullRender = portfolioIds !== existingIds;

            if (needsFullRender) {
                // Full render when holdings change
                container.innerHTML = gameState.portfolio.map(holding => {
                    const company = gameState.market.companies.find(c => c.id === holding.companyId);
                    return `
                        <div class="portfolio-item" data-company-id="${holding.companyId}">
                            <div class="portfolio-header">
                                <div>
                                    <div class="portfolio-name">${company.name}</div>
                                    <div class="portfolio-ticker">${company.ticker}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="portfolio-name" data-current-price></div>
                                    <div class="portfolio-ticker" data-price-change></div>
                                </div>
                            </div>
                            <div class="portfolio-grid">
                                <div class="portfolio-stat">
                                    <div class="portfolio-label">Î≥¥Ïú† ÏàòÎüâ</div>
                                    <div class="portfolio-value" data-qty></div>
                                </div>
                                <div class="portfolio-stat">
                                    <div class="portfolio-label">ÌèâÍ∑† Îã®Í∞Ä</div>
                                    <div class="portfolio-value" data-avg-cost></div>
                                </div>
                                <div class="portfolio-stat">
                                    <div class="portfolio-label">ÌèâÍ∞ÄÏï°</div>
                                    <div class="portfolio-value" data-total-value></div>
                                </div>
                                <div class="portfolio-stat">
                                    <div class="portfolio-label">ÏÜêÏùµ</div>
                                    <div class="portfolio-value" data-pnl></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Update values for each holding
            gameState.portfolio.forEach(holding => {
                const item = container.querySelector(`[data-company-id="${holding.companyId}"]`);
                if (!item) return;

                const currentPrice = gameState.market.prices[holding.companyId];
                const prevClose = gameState.market.previousClosePrices[holding.companyId];
                const change = ((currentPrice - prevClose) / prevClose * 100);
                const changeAmount = currentPrice - prevClose;
                const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : '';
                const changeSymbol = change > 0 ? '+' : '';

                const totalValue = currentPrice * holding.qty;
                const pnl = (currentPrice - holding.avgCost) * holding.qty;
                const pnlPercent = (pnl / (holding.avgCost * holding.qty)) * 100;
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';

                // Update dynamic values
                const priceEl = item.querySelector('[data-current-price]');
                const changeEl = item.querySelector('[data-price-change]');
                const qtyEl = item.querySelector('[data-qty]');
                const avgCostEl = item.querySelector('[data-avg-cost]');
                const totalValueEl = item.querySelector('[data-total-value]');
                const pnlEl = item.querySelector('[data-pnl]');

                if (priceEl) priceEl.textContent = formatMoneyWon(currentPrice);
                if (changeEl) {
                    changeEl.textContent = `${changeSymbol}${formatMoneyWon(changeAmount)} (${changeSymbol}${change.toFixed(2)}%)`;
                    changeEl.className = `portfolio-ticker ${changeClass}`;
                }
                if (qtyEl) qtyEl.textContent = holding.qty.toLocaleString() + 'Ï£º';
                if (avgCostEl) avgCostEl.textContent = formatMoneyWon(holding.avgCost);
                if (totalValueEl) totalValueEl.textContent = formatMoneyWon(totalValue);
                if (pnlEl) {
                    pnlEl.innerHTML = `${formatMoneyWon(pnl)}<br><span style="font-size: 11px;">(${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)</span>`;
                    pnlEl.className = `portfolio-value ${pnlClass}`;
                }
            });
        }

        // Render News
        function renderNews() {
            const container = document.getElementById('newsList');
            container.innerHTML = gameState.news.length ?
                gameState.news.map(news => createNewsHTML(news)).join('') :
                '<div class="empty-state">ÏïÑÏßÅ Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
        }

        function createNewsHTML(news) {
            const impactClass = news.impactNow >= 0 ? 'impact-positive' : 'impact-negative';
            const impactText = news.impactNow >= 0 ? `+${(news.impactNow * 100).toFixed(1)}%` : `${(news.impactNow * 100).toFixed(1)}%`;

            return `
                <div class="news-item ${news.scope}">
                    <div class="news-header">
                        <span>Day ${news.day} ${news.timeStr}</span>
                        <span>${news.scope === 'company' ? 'Í∏∞ÏóÖ' : news.scope === 'sector' ? 'ÏóÖÏ¢Ö' : 'ÏãúÏû•'}</span>
                    </div>
                    <div class="news-title">${news.title}</div>
                    <div class="news-description">${news.description}</div>
                    <div class="news-impact ${impactClass}">ÏòÅÌñ•: ${impactText}</div>
                </div>
            `;
        }

        // Show Toast
        function showToast(message) {
            // Limit number of active toasts
            if (activeToasts.length >= MAX_TOASTS) {
                const oldestToast = activeToasts.shift();
                oldestToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            activeToasts.push(toast);

            setTimeout(() => {
                toast.remove();
                const index = activeToasts.indexOf(toast);
                if (index > -1) activeToasts.splice(index, 1);
            }, 2500);
        }

        // Initialize
        init();
    </script>
</body>
</html>
